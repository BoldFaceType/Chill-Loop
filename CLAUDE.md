# CLAUDE.md - ChillLoop QuickStart v2.0

> Project-specific guidance for Claude Code when working with this home automation codebase.
> See [C:\Dev\CLAUDE.md](file:///C:/Dev/CLAUDE.md) for general DevOps environment guidance.

**Project Type**: Home Automation System (Dockerized)
**Primary Stack**: Home Assistant, Frigate NVR, Mosquitto MQTT, Ollama (LLM), Open-WebUI
**Runtime**: Docker Compose on WSL2 Ubuntu (Windows 11 host)
**Hardware**: BeeLink SER5 (AMD Ryzen 6800U) + RTX 3060 eGPU (headless)

---

## 1. Architecture Overview

### Service Flow
```
EC71 Cameras (RTSP) → Frigate NVR → MQTT (Mosquitto) → Home Assistant
                                                          ├─ Notifications (HA Companion + Telegram)
                                                          ├─ Cast to Onn 4K Pro (Android TV)
                                                          └─ Automations

Ollama (Docker + GPU) → Local LLM API → Open-WebUI

RTX 3060 eGPU (headless) → GPU passthrough → Ollama, Frigate (future TensorRT)

Android Audio Nodes → MQTT → Home Assistant (audio monitoring)
```

### Hardware Details

**BeeLink SER5 Mini-PC**:
- CPU: AMD Ryzen 7 6800U (8C/16T)
- RAM: 32GB (typical)
- OS: Windows 11 + WSL2 Ubuntu
- Display: HDMI from SER5 integrated graphics (AMD Radeon 680M)

**RTX 3060 eGPU**:
- Connection: OccuLink PCIe to SER5
- Mode: **Headless** (NO HDMI output needed)
- Usage: GPU passthrough to Docker containers (Ollama inference, Frigate TensorRT future)
- **CRITICAL**: eGPU is for compute only, NOT driving displays

**TP-Link EC71 Cameras**:
- Protocol: RTSP/ONVIF
- Dual streams: stream1 (1080p record), stream2 (720p detect)
- Setup: Enable RTSP in Tapo app, create camera account (separate from Tapo login)

**Onn 4K Pro Android TV**:
- Display endpoint for HA dashboards and camera feeds
- Modes: HA Cast (zero setup) OR Fully Kiosk Browser (true kiosk)
- ADB port: 5555 (for sideloading Fully Kiosk)

**Android Audio Nodes** (Optional):
- Samsung S10e (living_room) + Note20 (kitchen)
- Audio monitoring with MQTT publishing
- See Section 23 for details

---

## 2. Critical File Locations

### Configuration Files (CRITICAL - Do Not Break)

**[.env](file:///C:/Dev/projects/chillloop-quickstart/.env)**: Environment variables (secrets, IPs, credentials)
- NOT in git (use `.env.example` as template)
- Controls: TZ, MQTT creds, camera IPs, HA tokens, Ollama config
- 11 major configuration categories (see Section 20)

**[docker-compose.yml](file:///C:/Dev/projects/chillloop-quickstart/docker-compose.yml)**: Core service definitions
- Base compose file for all services
- Used with: `docker compose -f docker-compose.yml -f docker-compose.windows.yml up -d`

**[docker-compose.windows.yml](file:///C:/Dev/projects/chillloop-quickstart/docker-compose.windows.yml)**: WSL2/GPU overrides
- Windows-specific GPU passthrough config
- WSL path mappings (`/mnt/c/Dev/...`)
- **CRITICAL for GPU support on Windows**

**[config/frigate/config.yml](file:///C:/Dev/projects/chillloop-quickstart/config/frigate/config.yml)**: Frigate NVR config
- Camera definitions (dual-stream RTSP)
- Detection settings (detectors, zones, masks)
- Recording retention (7 days default)
- Uses `{PLACEHOLDER}` syntax replaced by bootstrap.sh

**[config/mosquitto/mosquitto.conf](file:///C:/Dev/projects/chillloop-quickstart/config/mosquitto/mosquitto.conf)**: MQTT broker
- Authentication (allow_anonymous: false)
- Password file: `config/mosquitto/passwd` (generated by bootstrap.sh)
- Ports: 1883 (MQTT), 9001 (WebSocket)

**[config/homeassistant/configuration.yaml](file:///C:/Dev/projects/chillloop-quickstart/config/homeassistant/configuration.yaml)**: HA core config
- Generated by bootstrap.sh if missing
- Package includes: `packages: !include_dir_named packages`
- MQTT integration to Mosquitto
- Frigate integration at http://frigate:5000

### Scripts (Automation Helpers)

- **[scripts/bootstrap.sh](file:///C:/Dev/projects/chillloop-quickstart/scripts/bootstrap.sh)**: Initial setup (creates MQTT users, substitutes .env vars, validates GPU)
- **[scripts/up.sh](file:///C:/Dev/projects/chillloop-quickstart/scripts/up.sh)**: Start all services (docker compose with both YAML files)
- **[scripts/down.sh](file:///C:/Dev/projects/chillloop-quickstart/scripts/down.sh)**: Stop services (supports `--purge`, `--nuke`)
- **[scripts/add_camera.sh](file:///C:/Dev/projects/chillloop-quickstart/scripts/add_camera.sh)**: Add camera to Frigate config
- **[scripts/add_sensor.sh](file:///C:/Dev/projects/chillloop-quickstart/scripts/add_sensor.sh)**: Add MQTT sensor to HA packages
- **[scripts/cast_dashboard.sh](file:///C:/Dev/projects/chillloop-quickstart/scripts/cast_dashboard.sh)**: Cast HA dashboard to Android TV
- **[scripts/cast_camera.sh](file:///C:/Dev/projects/chillloop-quickstart/scripts/cast_camera.sh)**: Cast camera feed to Android TV

### Android TV Integration

- **[android_tv/adb_install_fully.ps1](file:///C:/Dev/projects/chillloop-quickstart/android_tv/adb_install_fully.ps1)**: Windows PowerShell ADB installer for Fully Kiosk
- **[android_tv/adb_install_fully.sh](file:///C:/Dev/projects/chillloop-quickstart/android_tv/adb_install_fully.sh)**: WSL/Linux bash ADB installer
- **[android_tv/fully_config.json](file:///C:/Dev/projects/chillloop-quickstart/android_tv/fully_config.json)**: Fully Kiosk baseline config
- **[android_tv/ha_android_tv_helpers.yaml](file:///C:/Dev/projects/chillloop-quickstart/android_tv/ha_android_tv_helpers.yaml)**: HA Cast scripts (copied to HA packages by bootstrap)

### Data Directories (Git-ignored)

- **data/frigate**: Camera recordings (large, NOT backed up to git)
- **data/ollama**: LLM models (large)
- **data/homeassistant**: HA state database
- **data/mosquitto**: MQTT persistence

---

## 3. Windows/WSL2 Path Translation

### CRITICAL: Two Worlds, Two Paths

**Windows (PowerShell, Explorer)**:
- Project root: `C:\Dev\projects\chillloop-quickstart`
- Scripts: `C:\Dev\projects\chillloop-quickstart\scripts\*.ps1`
- Access: Native Windows file paths

**WSL2 Ubuntu (Bash, Docker)**:
- Project root: `/mnt/c/Dev/projects/chillloop-quickstart`
- Home symlink: `~/chillloop-quickstart` (if created)
- Scripts: All `.sh` files run in WSL

### When to Use Which

**Use PowerShell** (Windows) for:
- ADB operations: `android_tv\adb_install_fully.ps1`
- USB packaging: `scripts\package_to_usb.ps1`
- nvidia-smi checks (optional, also works in WSL)

**Use WSL Bash** for:
- Docker operations: ALL `scripts/up.sh`, `bootstrap.sh`, etc.
- MQTT tools: mosquitto_pub, mosquitto_passwd
- Frigate/HA config edits and restarts

### Docker Volume Mounts (in docker-compose.windows.yml)

Uses `/mnt/c/Dev/...` paths for WSL2 performance:
```yaml
volumes:
  - /mnt/c/Dev/projects/chillloop-quickstart/data/frigate:/media/frigate
```

---

## 4. Docker Operations & GPU Passthrough

### Starting Services (ALWAYS use both YAML files)

```bash
# In WSL Ubuntu
cd ~/chillloop-quickstart  # or /mnt/c/Dev/projects/chillloop-quickstart
docker compose -f docker-compose.yml -f docker-compose.windows.yml up -d
```

### Why Two Compose Files?

- **docker-compose.yml**: Base service definitions (portable)
- **docker-compose.windows.yml**: Windows/WSL2 overrides (GPU, paths)
- Merge strategy: `-f` flag layers configs (windows overrides base)

### GPU Passthrough (Windows-Specific Syntax)

**CRITICAL**: Windows Docker Desktop requires different GPU syntax than Linux.

**For Ollama** ([docker-compose.yml:192](file:///C:/Dev/projects/chillloop-quickstart/docker-compose.yml#L192)):
```yaml
deploy:
  resources:
    reservations:
      devices:
        - driver: nvidia
          capabilities: [gpu]
          count: all
runtime: nvidia
```

**For Frigate (future TensorRT)**:
```yaml
deploy:
  resources:
    reservations:
      devices:
        - driver: nvidia
          capabilities: [gpu, compute, utility]
          count: 1
```

**ANTI-PATTERN**: Do NOT use Linux syntax on Windows:
```yaml
# ❌ WRONG (Linux only)
devices:
  - /dev/dri:/dev/dri
environment:
  - LIBVA_DRIVER_NAME=i965
```

### Testing GPU in Docker

```bash
# Verify GPU passthrough works
docker run --rm --gpus all nvidia/cuda:12.4.1-base-ubuntu22.04 nvidia-smi

# Expected output: RTX 3060 details
```

---

## 5. Common Development Workflows

### 5.1 Adding a New Camera

**Method 1: Using add_camera.sh (Recommended)**
```bash
# With IP only (uses .env credentials)
bash scripts/add_camera.sh --name driveway --ip 192.168.1.101

# With full RTSP URL
bash scripts/add_camera.sh --name backyard --rtsp "rtsp://user:pass@192.168.1.102:554/stream2"
```

**What it does**:
1. Validates camera name doesn't exist
2. Builds dual-stream RTSP URLs (stream1 + stream2)
3. Appends camera block to [config/frigate/config.yml](file:///C:/Dev/projects/chillloop-quickstart/config/frigate/config.yml)
4. Restarts Frigate container

**Method 2: Manual Config Edit**
1. Edit [config/frigate/config.yml](file:///C:/Dev/projects/chillloop-quickstart/config/frigate/config.yml)
2. Add camera block under `cameras:` section
3. Restart: `docker compose -f docker-compose.yml -f docker-compose.windows.yml restart frigate`

### 5.2 Adding MQTT Sensors

```bash
bash scripts/add_sensor.sh --name laundry_door --topic "home/sensors/laundry_door" --class door
```

Creates package file: [config/homeassistant/packages/sensor_laundry_door.yaml](file:///C:/Dev/projects/chillloop-quickstart/config/homeassistant/packages/)

### 5.3 Configuring Automations

**Pattern**: Use HA packages (not monolithic automations.yaml)

**Location**: [config/homeassistant/packages/](file:///C:/Dev/projects/chillloop-quickstart/config/homeassistant/packages/)

Example package structure:
```yaml
automation:
  - alias: "Notify: Person at Front Door"
    trigger:
      - platform: mqtt
        topic: frigate/events
    condition:
      - "{{ trigger.payload_json.after.label == 'person' }}"
    action:
      - service: notify.mobile_app_your_phone
```

### 5.4 Casting to Android TV

**Mode A: HA Cast (Zero Setup)**
```bash
# Requires HA_TOKEN in .env
bash scripts/cast_dashboard.sh
bash scripts/cast_camera.sh cam_front
```

**Mode B: Fully Kiosk (True Kiosk)**
1. Enable ADB on Onn: Settings → Developer Options → Network debugging
2. Install Fully: `powershell android_tv/adb_install_fully.ps1` OR `bash android_tv/adb_install_fully.sh`
3. Configure in Fully settings: Start URL, Remote Admin password

### 5.5 Debugging Services

**View logs**:
```bash
bash scripts/logs.sh              # All services
bash scripts/logs.sh frigate      # Specific service
```

**Check container status**:
```bash
docker compose -f docker-compose.yml -f docker-compose.windows.yml ps
```

**Inspect GPU usage**:
```bash
nvidia-smi -l 1  # Live monitoring (1 sec refresh)
```

**Test MQTT**:
```bash
# Subscribe
mosquitto_sub -h localhost -u chillloop -P <password> -t '#' -v

# Publish
mosquitto_pub -h localhost -u chillloop -P <password> -t 'home/test' -m 'hello'
```

**Test RTSP stream**:
```bash
ffmpeg -i "rtsp://user:pass@192.168.1.100:554/stream2" -frames:v 1 test.jpg
```

---

## 6. Configuration Patterns

### 6.1 Environment Variable Substitution

Frigate config uses `{PLACEHOLDER}` syntax:
```yaml
cameras:
  cam_front:
    ffmpeg:
      inputs:
        - path: rtsp://{EC71_USER}:{EC71_PASS}@{EC71_IP}:554/stream2
```

Replaced by [bootstrap.sh:77-81](file:///C:/Dev/projects/chillloop-quickstart/scripts/bootstrap.sh#L77-L81):
```bash
sed -e "s/{EC71_USER}/${EC71_USER}/g" \
    -e "s/{EC71_PASS}/${EC71_PASS}/g" \
    -e "s/{EC71_IP}/${EC71_IP}/g" \
    "$FRIGATE_CONFIG" > "${FRIGATE_CONFIG}.tmp"
```

### 6.2 MQTT Topic Conventions

- **Frigate events**: `frigate/events` (JSON payload with camera, label, event_id)
- **Custom sensors**: `home/sensors/<sensor_name>` (ON/OFF payloads)
- **ChillLoop prefix**: Use `home/` for custom integrations
- **Android Audio**: `chillloop/audio/{room}/metrics` (see Section 23)

### 6.3 Home Assistant Packages

Package pattern (modular config):
```yaml
# config/homeassistant/packages/camera_alerts.yaml
automation:
  - alias: "Alert name"
    # automation config

script:
  script_name:
    # script config

input_text:
  helper_name:
    # input helper config
```

Included by: `homeassistant: { packages: !include_dir_named packages }`

### 6.4 Bash Script Conventions

All scripts follow pattern:
```bash
#!/usr/bin/env bash
set -euo pipefail  # Exit on error, undefined var, pipe failure

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Source .env if needed
set -a
source "$PROJECT_ROOT/.env"
set +a
```

---

## 7. Service Endpoints

### Access Points (from Windows or WSL)

- **Home Assistant**: http://localhost:8123
- **Frigate NVR**: http://localhost:5000
- **Open-WebUI**: http://localhost:3000
- **Ollama API**: http://localhost:11434

### Docker Network (container-to-container)

- **Home Assistant**: http://homeassistant:8123
- **Frigate**: http://frigate:5000
- **Mosquitto MQTT**: mqtt://mosquitto:1883
- **Ollama**: http://ollama:11434

### MQTT Credentials

- **Users**: `chillloop`, `frigate`, `homeassistant` (all same password from .env MQTT_PASS)
- **Created by**: [bootstrap.sh:59-66](file:///C:/Dev/projects/chillloop-quickstart/scripts/bootstrap.sh#L59-L66) using mosquitto_passwd
- **File**: [config/mosquitto/passwd](file:///C:/Dev/projects/chillloop-quickstart/config/mosquitto/passwd)

### Home Assistant Long-Lived Token

- **Generate**: Profile → Security → Long-Lived Access Tokens
- **Store in**: `.env` as `HA_TOKEN=...`
- **Used by**: cast_dashboard.sh, cast_camera.sh (HA REST API)

---

## 8. Troubleshooting Guide

### 8.1 GPU Not Detected in Docker

**Symptoms**: Ollama runs slow, nvidia-smi doesn't show containers

**Checks**:
```bash
# 1. Verify GPU visible in Windows
nvidia-smi  # Should show RTX 3060

# 2. Verify GPU visible in WSL
wsl nvidia-smi

# 3. Test Docker GPU access
docker run --rm --gpus all nvidia/cuda:12.4.1-base-ubuntu22.04 nvidia-smi
```

**Fixes**:
- Install/update NVIDIA drivers on Windows
- Enable GPU support in Docker Desktop: Settings → Resources → WSL Integration → Enable GPU
- Try HDMI dummy plug on RTX 3060 (some eGPUs need this for detection)
- Restart Docker Desktop

### 8.2 Camera Not Appearing in Frigate

**Checks**:
```bash
# 1. Test RTSP stream
ffmpeg -i "rtsp://user:pass@192.168.1.100:554/stream2" -frames:v 1 test.jpg

# 2. Check Frigate logs
bash scripts/logs.sh frigate

# 3. Verify camera config
cat config/frigate/config.yml | grep -A 20 "cam_front:"
```

**Common causes**:
- Wrong RTSP credentials (use camera account, not Tapo login)
- Camera IP changed (check DHCP reservation)
- RTSP/ONVIF not enabled in Tapo app
- Stream path wrong (EC71 uses `/stream1` and `/stream2`)

### 8.3 Android TV Cast Not Working

**Checks**:
```bash
# 1. Verify HA_TOKEN is set
echo $HA_TOKEN

# 2. Test HA API manually
curl -H "Authorization: Bearer $HA_TOKEN" http://localhost:8123/api/

# 3. Check if Android TV entity exists in HA
# Go to HA UI → Settings → Devices & Services
```

**Fixes**:
- Generate HA token: Profile → Security → Long-Lived Access Tokens
- Add token to .env: `HA_TOKEN=your_token_here`
- Ensure Onn 4K Pro and SER5 on same network
- Check Google Cast integration in HA (should auto-discover)

### 8.4 MQTT Connection Failures

**Checks**:
```bash
# Test MQTT connection
mosquitto_sub -h localhost -u chillloop -P <password> -t 'test' -v

# Check Mosquitto logs
bash scripts/logs.sh mosquitto
```

**Common causes**:
- Wrong password (check .env MQTT_PASS)
- Password file not regenerated after .env change (re-run bootstrap.sh)
- Mosquitto container not running

### 8.5 Services Won't Start

**Checks**:
```bash
# Check Docker status
docker ps -a

# Check compose file syntax
docker compose -f docker-compose.yml -f docker-compose.windows.yml config

# Check logs
bash scripts/logs.sh
```

**Common causes**:
- `.env` file missing (copy from .env.example)
- Docker Desktop not running
- Port conflicts (8123, 5000, 3000, 11434 already in use)
- WSL2 not configured or outdated

---

## 9. Anti-Patterns (Don't Do This)

### 9.1 Breaking GPU Configuration

❌ **NEVER** use Linux GPU syntax in docker-compose.yml:
```yaml
# WRONG on Windows
devices:
  - /dev/dri:/dev/dri
```

✅ **ALWAYS** use Windows deploy syntax:
```yaml
# CORRECT on Windows
deploy:
  resources:
    reservations:
      devices:
        - driver: nvidia
          capabilities: [gpu]
```

### 9.2 Incorrect Volume Mounts

❌ **NEVER** use Windows paths in docker-compose.yml:
```yaml
# WRONG
volumes:
  - C:\Dev\projects\chillloop-quickstart\data:/data
```

✅ **ALWAYS** use WSL paths in docker-compose.windows.yml:
```yaml
# CORRECT
volumes:
  - /mnt/c/Dev/projects/chillloop-quickstart/data:/data
```

### 9.3 Running Docker Without Both YAML Files

❌ **WRONG**:
```bash
docker compose up -d  # Missing Windows overrides!
```

✅ **CORRECT**:
```bash
docker compose -f docker-compose.yml -f docker-compose.windows.yml up -d
```

### 9.4 Editing Generated Files

❌ **NEVER** manually edit after bootstrap:
- `config/mosquitto/passwd` (regenerated by bootstrap.sh)
- `config/homeassistant/configuration.yaml` (if bootstrap created it)

✅ **DO** edit source files:
- `.env` (all environment variables)
- `config/frigate/config.yml` (placeholders replaced on bootstrap)

### 9.5 Committing Secrets

❌ **NEVER** commit to git:
- `.env` (contains passwords, tokens, IPs)
- `data/` directory (recordings, models, databases)
- `config/mosquitto/passwd` (hashed passwords)

✅ **DO** commit:
- `.env.example` (template without secrets)
- All scripts, compose files, seed configs

### 9.6 Breaking eGPU Setup

❌ **NEVER**:
- Route TV HDMI through RTX 3060 (eGPU is headless!)
- Disable GPU in Docker Desktop settings
- Mix CUDA versions (stick to 12.4.1 for compatibility)

✅ **DO**:
- Keep TV connected to SER5 integrated graphics
- Test GPU with `nvidia-smi` before running services
- Update NVIDIA drivers on Windows when needed

---

## 10. Integration Points

### 10.1 Frigate → MQTT → Home Assistant

**Flow**:
1. Frigate detects person in camera frame
2. Frigate publishes to `frigate/events` (MQTT)
3. HA automation triggered by MQTT message
4. HA calls `script.cast_frigate_event` (Android TV)
5. HA sends notification via mobile app

**Key files**:
- Frigate config: [config/frigate/config.yml](file:///C:/Dev/projects/chillloop-quickstart/config/frigate/config.yml) (mqtt section)
- HA automation: [android_tv/ha_android_tv_helpers.yaml](file:///C:/Dev/projects/chillloop-quickstart/android_tv/ha_android_tv_helpers.yaml)

### 10.2 Home Assistant → Ollama (Future)

**Flow**:
1. HA automation triggers on event
2. HA calls Ollama API: `http://ollama:11434/api/generate`
3. LLM processes request (GPU accelerated)
4. Response used in automation decision

**Key config**:
- Ollama endpoint: `http://ollama:11434` (from HA containers)
- Models: Pulled via Open-WebUI or `docker exec chillloop-ollama ollama pull <model>`

### 10.3 Scripts → Home Assistant REST API

**Pattern**:
```bash
curl -X POST "$HA_URL/api/services/script/turn_on" \
  -H "Authorization: Bearer $HA_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"entity_id":"script.cast_dashboard"}'
```

**Used by**:
- [scripts/cast_dashboard.sh](file:///C:/Dev/projects/chillloop-quickstart/scripts/cast_dashboard.sh)
- [scripts/cast_camera.sh](file:///C:/Dev/projects/chillloop-quickstart/scripts/cast_camera.sh)

**Requires**: HA_TOKEN in .env

---

## 11. Maintenance & Updates

### 11.1 Updating Services

```bash
bash scripts/update.sh
# Pulls latest images, recreates containers, preserves data
```

### 11.2 Backup Strategy

**What to backup**:
- `.env` file (encrypted/secure storage)
- `config/` directory (all configs)
- `data/homeassistant/` (HA state, history)
- Optional: `data/frigate/` (recordings - very large)

**What NOT to backup**:
- `data/ollama/` (models - re-downloadable)
- `data/mosquitto/` (transient MQTT data)

**Backup script**: [backups/backup.sh](file:///C:/Dev/projects/chillloop-quickstart/backups/) (placeholder directory exists)

### 11.3 Storage Management

**Frigate retention** (default 7 days):
```yaml
# config/frigate/config.yml
record:
  retain:
    days: 7
    mode: motion
```

**Adjust for storage**:
- 1 camera @ 1080p ≈ 2-5GB/day
- 4 cameras × 7 days ≈ 60-140GB

**Monitor storage**:
```bash
docker exec chillloop-frigate df -h /media/frigate
```

### 11.4 Stopping Services

```bash
# Stop, keep data
bash scripts/down.sh

# Stop, prune unused images
bash scripts/down.sh --purge

# ⚠️ DANGER: Delete ALL data
bash scripts/down.sh --nuke
```

---

## 12. Extension Patterns

### 12.1 Adding New Services

**Pattern**:
1. Add service to `docker-compose.yml`
2. Add Windows-specific overrides to `docker-compose.windows.yml` (if needed)
3. Create config directory: `config/<service>/`
4. Add volume mount for persistence: `data/<service>/`
5. Update bootstrap.sh if service needs initialization
6. Document in this CLAUDE.md

### 12.2 Adding Ollama Models

```bash
# Via Open-WebUI (http://localhost:3000)
# OR via CLI:
docker exec -it chillloop-ollama ollama pull llama2
docker exec -it chillloop-ollama ollama list
```

### 12.3 Creating Custom HA Integrations

**Location**: `config/homeassistant/custom_components/`

**Pattern**:
1. Create component directory
2. Add `__init__.py`, `manifest.json`
3. Restart HA container

### 12.4 Adding New Automation Scripts

**Pattern** (follow existing scripts):
```bash
#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Source .env
set -a
source "$PROJECT_ROOT/.env"
set +a

# Script logic here
```

**Make executable**:
```bash
chmod +x scripts/new_script.sh
```

---

## 13. Quick Reference Commands

### First-Time Setup
```bash
cd /mnt/c/Dev/projects/chillloop-quickstart
cp .env.example .env
nano .env  # Configure all variables
bash scripts/bootstrap.sh
bash scripts/up.sh
```

### Daily Operations
```bash
# Start services
bash scripts/up.sh

# Stop services
bash scripts/down.sh

# View logs
bash scripts/logs.sh [service]

# Update containers
bash scripts/update.sh
```

### Camera Management
```bash
# Add camera
bash scripts/add_camera.sh --name <name> --ip <ip>

# Test RTSP stream
ffmpeg -i "rtsp://user:pass@ip:554/stream2" -frames:v 1 test.jpg
```

### Android TV
```bash
# Cast dashboard
bash scripts/cast_dashboard.sh

# Cast camera
bash scripts/cast_camera.sh <camera_name>

# Install Fully Kiosk (Windows)
powershell android_tv/adb_install_fully.ps1
```

### MQTT Testing
```bash
# Subscribe
mosquitto_sub -h localhost -u chillloop -P <password> -t '#' -v

# Publish
mosquitto_pub -h localhost -u chillloop -P <password> -t 'home/test' -m 'ON'
```

### GPU Monitoring
```bash
nvidia-smi -l 1  # Live GPU usage
docker run --rm --gpus all nvidia/cuda:12.4.1-base-ubuntu22.04 nvidia-smi  # Test Docker GPU
```

### Docker Compose
```bash
# Always use both files
docker compose -f docker-compose.yml -f docker-compose.windows.yml <command>

# Shortcuts
bash scripts/up.sh      # = docker compose ... up -d
bash scripts/down.sh    # = docker compose ... down
bash scripts/logs.sh    # = docker compose ... logs -f
```

---

## 14. Security Best Practices

### 14.1 Credential Management

✅ **DO**:
- Use strong passwords in `.env`
- Generate separate camera accounts (not Tapo login)
- Create unique MQTT password
- Use long-lived HA tokens (revocable)

❌ **DON'T**:
- Commit `.env` to git
- Reuse passwords across services
- Expose Frigate to internet (camera feeds are sensitive)

### 14.2 Network Security

**Recommended**:
- Keep all devices on same private LAN
- Use static IP reservations (cameras, Onn TV)
- Firewall rules: Block external access to ports 1883, 5000, 11434
- HA external access: Use Nabu Casa or reverse proxy with SSL

### 14.3 Android TV

**Fully Kiosk**:
- Enable remote admin ONLY on LAN
- Use strong remote admin password
- Disable ADB network debugging after setup (security risk if exposed)

**HA Cast**:
- Less risk (uses Google Cast protocol)
- HA token still required (keep secret)

### 14.4 Docker Security

**Best practices**:
- Don't run containers as root (where possible)
- Use `privileged: true` sparingly (only HA, Frigate need it)
- Keep Docker Desktop updated
- Regular `docker image prune` to remove vulnerabilities

---

## 15. Performance Optimization

### 15.1 Frigate Detection

**CPU mode** (current default):
```yaml
detectors:
  cpu1:
    type: cpu
    num_threads: 3
```

**Future TensorRT** (GPU accelerated):
```yaml
detectors:
  tensorrt:
    type: tensorrt
    device: 0  # RTX 3060

ffmpeg:
  hwaccel_args: preset-nvidia-h264
```

**Requires**: Frigate TensorRT image + GPU passthrough config

### 15.2 Ollama Performance

**Model selection**:
- Small models (7B): ~4GB VRAM, faster inference
- Large models (13B+): ~8GB+ VRAM, slower but better quality

**Check GPU usage**:
```bash
nvidia-smi  # Should show ollama process using GPU
```

### 15.3 Storage Performance

**Best practices**:
- Use SSD for `data/frigate` (camera recordings)
- Frigate recordings: Enable motion-only mode
- Adjust retention based on available storage

### 15.4 Network Optimization

**Camera streams**:
- Use stream2 (sub-stream) for detection: Lower bandwidth, faster processing
- Use stream1 (main stream) for recording: Higher quality
- Avoid transcoding when possible (direct passthrough)

---

## 16. Version History

### v2.0 (Current)
- Corrected hardware: BeeLink SER5 (not CIR5)
- Dropped RPi-5 and Nest Hub 2nd Gen
- Onn 4K Pro as sole TV endpoint
- eGPU headless mode (compute only)
- Ollama-only model runner
- Added MCP helpers and USB packaging
- Windows/WSL2 Docker Compose GPU syntax

### v1.9
- Added Android TV endpoint (Onn 4K Pro)
- HA Cast and Fully Kiosk support
- ADB sideloading scripts

### v1.8
- Initial closed-loop baseline
- WSL2 deployment
- EC71 camera seed configuration
- MQTT + Frigate + HA integration

---

## 17. Related Documentation

### Project Documentation
- **[README.md](file:///C:/Dev/projects/chillloop-quickstart/README.md)**: User-facing quick start guide
- **[Chill-Loop QuickStart v2.0.md](file:///C:/Dev/projects/Chill-Loop%20QuickStart%20v2.0.md)**: Technical specification
- **[ChillLoop HomeLab installation plan 12-10-25.md](file:///C:/Dev/projects/ChillLoop%20HomeLab%20installation%20plan%2012-10-25.md)**: Installation walkthrough

### External References
- **Home Assistant**: https://www.home-assistant.io/docs/
- **Frigate NVR**: https://docs.frigate.video/
- **Ollama**: https://github.com/ollama/ollama
- **EC71 RTSP**: Tapo app → Camera Settings → Advanced → RTSP/ONVIF

### Parent Environment
- **[C:\Dev\CLAUDE.md](file:///C:/Dev/CLAUDE.md)**: DevOps workspace conventions
- **[C:\Dev\projects\QUICK_REFERENCE.md](file:///C:/Dev/projects/QUICK_REFERENCE.md)**: General command cheatsheet
- **[C:\Dev\projects\EXECUTION_GUIDE.md](file:///C:/Dev/projects/EXECUTION_GUIDE.md)**: Setup script documentation

---

## 18. Critical Files for Implementation

If implementing changes to this project, these are the most critical files to understand:

1. **[docker-compose.yml](file:///C:/Dev/projects/chillloop-quickstart/docker-compose.yml)** - Core service orchestration, defines all containers
2. **[docker-compose.windows.yml](file:///C:/Dev/projects/chillloop-quickstart/docker-compose.windows.yml)** - Windows/WSL2 GPU passthrough config (CRITICAL for GPU support)
3. **[.env.example](file:///C:/Dev/projects/chillloop-quickstart/.env.example)** - Environment variable template (all configuration originates here)
4. **[config/frigate/config.yml](file:///C:/Dev/projects/chillloop-quickstart/config/frigate/config.yml)** - Camera detection and recording configuration
5. **[scripts/bootstrap.sh](file:///C:/Dev/projects/chillloop-quickstart/scripts/bootstrap.sh)** - Initialization logic (MQTT users, config substitution, validation)

---

## 19. Bootstrap Process Deep Dive

### What bootstrap.sh Does

**Step-by-step** ([bootstrap.sh:1-100](file:///C:/Dev/projects/chillloop-quickstart/scripts/bootstrap.sh#L1-L100)):

1. **Validates `.env` exists** (line 13)
   - Exits with error if missing
   - Instructs user to copy from `.env.example`

2. **Checks required tools** (line 27)
   - docker, docker compose, mosquitto_passwd
   - Lists missing tools with install instructions

3. **Creates MQTT users** (line 52)
   - Removes old password file
   - Creates three users: `chillloop`, `frigate`, `homeassistant`
   - All use same password from `MQTT_PASS` in .env
   - Uses `mosquitto_passwd -b -c` for first, `-b` for subsequent

4. **Substitutes Frigate placeholders** (line 72)
   - Replaces `{EC71_USER}`, `{EC71_PASS}`, `{EC71_IP}`, `{FRIGATE_MQTT_PASSWORD}`
   - Uses `sed` with temporary file
   - Moves temp file over original

5. **Creates data directories** (line 88)
   - `data/ollama`, `data/frigate`, `data/homeassistant`, `data/mosquitto`
   - `data/mosquitto/data` and `data/mosquitto/log` subdirectories

6. **Validates GPU** (line 96)
   - Checks `nvidia-smi` availability
   - Displays GPU name, driver version, memory
   - Continues if GPU not found (not fatal)

7. **Tests Docker GPU** (optional, if GPU found)
   - Runs test container with GPU passthrough
   - Verifies Docker can access GPU

### When to Re-run Bootstrap

**Must re-run** if:
- Changed MQTT_PASS in .env (regenerates password file)
- Changed camera credentials in .env (updates Frigate config)
- Added new placeholder variables to Frigate config

**No need to re-run** if:
- Changed HA_TOKEN or other non-MQTT, non-camera variables
- Modified Frigate config manually (placeholders already replaced)
- Updated scripts (bootstrap doesn't modify scripts)

### What Gets Regenerated vs Preserved

**Regenerated** (overwrites):
- `config/mosquitto/passwd` (MQTT password file)
- `config/frigate/config.yml` (placeholders replaced)

**Preserved** (only created if missing):
- `data/` directories (keeps existing data)
- `config/homeassistant/configuration.yaml` (if manually created)

---

## 20. .env Variable Reference

Complete reference of all environment variables in [.env.example](file:///C:/Dev/projects/chillloop-quickstart/.env.example):

### 1. Timezone
| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `TZ` | Yes | `America/New_York` | Timezone for automations and recordings |

### 2. MQTT Configuration
| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `MQTT_USER` | Yes | `chillloop` | MQTT broker username |
| `MQTT_PASS` | Yes | `change-me-mqtt-password` | MQTT broker password (used by all 3 users) |

### 3. EC71 Camera Configuration
| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `EC71_USER` | Yes | `camera-user` | Camera account username (NOT Tapo login) |
| `EC71_PASS` | Yes | `change-me-camera-password` | Camera account password |
| `EC71_IP` | Yes | `192.168.1.100` | Primary camera IP address |
| `EC71_IP_DRIVEWAY` | No | - | Additional camera IP (optional) |
| `EC71_IP_BACKYARD` | No | - | Additional camera IP (optional) |

### 4. Frigate Configuration
| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `FRIGATE_RTSP_PASSWORD` | Yes | `change-me-frigate-rtsp` | Frigate RTSP restream password |

### 5. Home Assistant Configuration
| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `HA_NOTIFY_SERVICE` | Yes | `notify.mobile_app_your_phone` | HA notification service entity ID |
| `HA_LATITUDE` | Yes | `40.7128` | Home location latitude |
| `HA_LONGITUDE` | Yes | `-74.0060` | Home location longitude |
| `HA_ELEVATION` | Yes | `10` | Home elevation in meters |

### 6. Telegram Notifications (Optional)
| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `TELEGRAM_BOT_TOKEN` | No | - | Telegram bot token (fallback notifications) |
| `TELEGRAM_CHAT_ID` | No | - | Telegram chat ID for notifications |

### 7. Open-WebUI / Ollama Configuration
| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `WEBUI_SECRET_KEY` | Yes | `change-this-to-a-random-secret-key` | Open-WebUI session secret |

### 8. Onn 4K Pro Android TV Configuration
| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `ONN_IP` | Yes | `192.168.1.50` | Onn 4K Pro IP address (static recommended) |
| `ONN_ADB_PORT` | Yes | `5555` | ADB network port |

### 9. Fully Kiosk Configuration (Mode B)
| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `FULLY_REMOTE_ADMIN_PASSWORD` | No | `change-me-fully-password` | Fully Kiosk remote admin password |

### 10. Home Assistant Long-Lived Access Token
| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `HA_TOKEN` | Yes* | - | Long-lived access token (generate in HA UI) |

*Required for casting scripts

### 11. Service URLs
| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `HA_URL` | Yes | `http://localhost:8123` | Home Assistant URL |
| `FRIGATE_URL` | Yes | `http://localhost:5000` | Frigate URL |
| `OLLAMA_URL` | Yes | `http://localhost:11434` | Ollama API URL |
| `OPENWEBUI_URL` | Yes | `http://localhost:3000` | Open-WebUI URL |

---

## 21. Camera RTSP Setup Guide

### Step-by-Step Tapo App Walkthrough

**1. Enable RTSP/ONVIF in Tapo App**:
1. Open Tapo app on your phone
2. Select the EC71 camera
3. Tap gear icon (Settings) in top right
4. Scroll to **Advanced Settings**
5. Tap **Camera Account**

**2. Create Camera Account**:
1. Tap "Add" or "Create Account"
2. **Username**: Enter a username (e.g., `camera-user`)
3. **Password**: Create a strong password
4. **IMPORTANT**: This is NOT your Tapo account credentials
5. Save the account

**3. Enable RTSP**:
1. Still in Advanced Settings
2. Find **RTSP** toggle
3. Enable RTSP
4. Note the port (usually 554)

**4. Enable ONVIF** (optional but recommended):
1. In Advanced Settings
2. Find **ONVIF** toggle
3. Enable ONVIF

**5. Reserve Static IP**:
1. Log into your router admin interface
2. Find DHCP reservations or static IP assignments
3. Reserve an IP for the camera's MAC address
4. Suggested IPs: `192.168.1.100`, `192.168.1.101`, etc.

### Finding Stream Paths

**EC71 Stream Paths**:
- **Main stream** (1080p, high bitrate): `rtsp://[user]:[pass]@[ip]:554/stream1`
- **Sub stream** (720p, low bitrate): `rtsp://[user]:[pass]@[ip]:554/stream2`

**Usage**:
- `stream1` for recording (high quality)
- `stream2` for detection (lower bandwidth, faster processing)

### Testing RTSP Stream

```bash
# Test main stream
ffmpeg -i "rtsp://camera-user:your-password@192.168.1.100:554/stream1" -frames:v 1 test_stream1.jpg

# Test sub stream
ffmpeg -i "rtsp://camera-user:your-password@192.168.1.100:554/stream2" -frames:v 1 test_stream2.jpg
```

If successful, you'll see a snapshot saved as `test_stream1.jpg` or `test_stream2.jpg`.

### Troubleshooting RTSP

**"Connection refused" or "401 Unauthorized"**:
- Verify RTSP is enabled in Tapo app
- Check username/password (use camera account, NOT Tapo login)
- Confirm camera is on same network as SER5

**"Timeout" or "No route to host"**:
- Verify camera IP address
- Ping camera: `ping 192.168.1.100`
- Check firewall rules

**Stream works but Frigate shows "No Signal"**:
- Check Frigate logs: `bash scripts/logs.sh frigate`
- Verify placeholders replaced in config: `cat config/frigate/config.yml`
- Ensure bootstrap.sh completed successfully

---

## 22. Docker Compose Merge Behavior

### How `-f` Flag Layers Configurations

When you run:
```bash
docker compose -f docker-compose.yml -f docker-compose.windows.yml up -d
```

Docker Compose merges the files **in order**, with later files overriding earlier ones.

### What Gets Overridden

**From [docker-compose.windows.yml:8-11](file:///C:/Dev/projects/chillloop-quickstart/docker-compose.windows.yml#L8-L11)**:
```yaml
services:
  frigate:
    volumes:
      - /mnt/c/Dev/projects/chillloop-quickstart/config/frigate:/config  # Overrides base path
```

**Result**: The `volumes` list in `docker-compose.windows.yml` **replaces** the `volumes` list from `docker-compose.yml` for the `frigate` service.

**From [docker-compose.windows.yml:17-25](file:///C:/Dev/projects/chillloop-quickstart/docker-compose.windows.yml#L17-L25)**:
```yaml
services:
  ollama:
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu, compute, utility]
```

**Result**: Adds `deploy` section to `ollama` service (didn't exist in base file).

### What Stays the Same

**From base [docker-compose.yml](file:///C:/Dev/projects/chillloop-quickstart/docker-compose.yml)**:
- Service definitions (image, container_name, restart policy)
- Network definitions
- Environment variables (unless explicitly overridden)
- Ports (unless explicitly overridden)

**Example**:
```yaml
# docker-compose.yml
services:
  frigate:
    image: ghcr.io/blakeblackshear/frigate:stable
    ports:
      - "5000:5000"
    environment:
      FRIGATE_RTSP_PASSWORD: "from-env"
```

These stay intact unless `docker-compose.windows.yml` explicitly overrides them.

### When to Edit Which File

**Edit `docker-compose.yml`** for:
- Adding new services
- Changing ports
- Updating image tags
- Modifying environment variables
- Changing service dependencies

**Edit `docker-compose.windows.yml`** for:
- GPU configuration changes
- Volume path updates (WSL path changes)
- Windows-specific environment variables
- Windows-specific device mappings

### Merge Rules Summary

| Element | Behavior |
|---------|----------|
| **Scalars** (strings, numbers) | Later file **replaces** earlier |
| **Lists** (volumes, ports) | Later file **replaces** earlier list |
| **Maps** (environment, labels) | Later file **merges** with earlier (key-level override) |
| **Networks** | Merged (union of both files) |
| **Volumes** (top-level) | Merged (union of both files) |

### Testing Merge Result

```bash
# See merged configuration
docker compose -f docker-compose.yml -f docker-compose.windows.yml config

# Save merged config to file
docker compose -f docker-compose.yml -f docker-compose.windows.yml config > merged-compose.yml
```

---

## 23. Android Audio Nodes (ChillLoop)

### Component Overview

**Version**: 0.2.0 (Production-Ready MVP)
**Targets**: CL-CORE v1.0.0
**Status**: Ready for Christmas deployment
**Devices**: Samsung S10e (living_room), Note20 (kitchen)

**Purpose**: Use Android phones as audio monitoring nodes to detect voice levels (dB SPL) and publish metrics via MQTT for behavioral loop automations (bedtime consistency, de-escalation).

### Architecture

**Foreground Service**:
- Continuous audio monitoring (16kHz sample rate)
- RMS (Root Mean Square) audio level computation
- dBFS (decibels Full Scale) → dB SPL calibration (94dB offset)
- VAD-based publishing (Voice Activity Detection)

**Audio Processing**:
- Sample rate: 16kHz (fixed)
- Publish interval: 500ms
- Silence threshold: -40.0 dBFS
- Heartbeat: 5000ms in silent periods
- Calibration: 94.0dB SPL offset (typical phone mic standard)

**MQTT Publishing**:
- Metrics: 500ms interval, QoS=0 (high-frequency)
- Events: Low-frequency, QoS=1 (escalation events)
- Health: Lifecycle messages, QoS=1, retained

### MQTT Topics (Documented Namespace Exception)

**Rationale**: High-frequency metrics (500ms interval) benefit from flat structure for performance.

```
Metrics (high-frequency):  chillloop/audio/{room}/metrics (QoS=0, non-retained, 500ms)
Events (low-frequency):    chillloop/event/audio/{room}/escalation (QoS=1)
Health (lifecycle):        chillloop/health/nodes/{node_id} (QoS=1, retained)
```

**Metrics Payload** (minimal envelope):
```json
{
  "node_id": "android_s10e_living",
  "room_id": "living_room",
  "db_spl": "63.4",
  "ts": 1702409823456
}
```

**Event Payload** (full envelope):
```json
{
  "ts": "2023-12-12T10:30:23Z",
  "source": "android_s10e_living",
  "type": "escalation_start",
  "node_id": "android_s10e_living",
  "room_id": "living_room",
  "data": {
    "db_spl": 75.2,
    "duration_ms": 3000,
    "reason": "threshold_exceeded"
  },
  "goal_tag": "bedtime_consistency"
}
```

### Critical Dependencies

**From build.gradle.kts**:
- **Kotlin Coroutines**: 1.7.3
- **Paho MQTT Client**: 1.2.5 (Java) / 1.1.1 (Android Service)
- **AndroidX Core**: 1.12.0
- **AndroidX AppCompat**: 1.6.1
- **JSON**: org.json 20231013
- **minSdk**: 26 (Android 8.0+)
- **compileSdk**: 34 (Android 14)

### Security Model

**MVP (Christmas Deployment)**:
- BuildConfig credentials (acceptable for trusted home network)
- Credentials in `gradle.properties` (gitignored)
- MQTT user: `chillloop_mobile`
- DNS: `mqtt.home` (aligned with uns.json)

**Production (Future)**:
- Android Keystore for credential storage
- TLS for MQTT transport (port 8883)
- Client certificate authentication

### Deployment Guide

**Pre-Deployment Checklist**:
- [ ] Replace `MQTT_PASSWORD` in `gradle.properties` (gitignored)
- [ ] Update `room_id` in `loadConfig()` method per device
- [ ] Test MQTT connectivity: `mosquitto_sub -h mqtt.home -t "chillloop/audio/#" -v`
- [ ] Verify `.home` DNS resolution on Android devices

**Android Device Setup** (S10e & Note20):
1. **Enable Developer Options**: Settings → About → Tap "Build Number" 7x
2. **Battery Optimization**: Settings → Apps → ChillLoop → Battery → **Unrestricted**
3. **Disable "Put app to sleep"**: Same location as battery optimization
4. **Lock app in Recents**: Open Recents, tap app icon, select "Pin" or "Lock"
5. **Keep plugged into power**: Wall charger (not USB)

**Installation Steps**:
1. Build APK: `./gradlew assembleRelease` (from Android Studio or CLI)
2. Install on S10e: `adb install -r app/build/outputs/apk/release/app-release.apk`
3. Start service: Open app, tap "Start Monitoring"
4. Verify notification appears in status bar
5. Monitor MQTT: `mosquitto_sub -h mqtt.home -t "chillloop/audio/living_room/metrics" -v`
6. Test: Speak loudly, verify `db_spl >50` messages appear
7. Test: Wait 10 seconds in silence, verify heartbeat with `status="silent"`
8. Repeat for Note20 (kitchen)

### Integration with Home Assistant

**MQTT Sensor Configuration** (add to HA packages):
```yaml
# config/homeassistant/packages/audio_nodes.yaml
mqtt:
  sensor:
    - name: "Living Room Audio Level"
      state_topic: "chillloop/audio/living_room/metrics"
      value_template: "{{ value_json.db_spl }}"
      unit_of_measurement: "dB SPL"
      device_class: sound_pressure

    - name: "Kitchen Audio Level"
      state_topic: "chillloop/audio/kitchen/metrics"
      value_template: "{{ value_json.db_spl }}"
      unit_of_measurement: "dB SPL"
      device_class: sound_pressure
```

**Escalation Detection Automation**:
```yaml
automation:
  - alias: "Audio: Escalation Detected"
    trigger:
      - platform: mqtt
        topic: "chillloop/event/audio/+/escalation"
    condition:
      - "{{ trigger.payload_json.type == 'escalation_start' }}"
    action:
      - service: notify.mobile_app_parent_phone
        data:
          message: "Escalation detected in {{ trigger.payload_json.room_id }}"
          data:
            tag: "audio_escalation_{{ trigger.payload_json.room_id }}"
```

### Troubleshooting

**Battery Optimization Killing Service**:
- Verify unrestricted battery: Settings → Apps → ChillLoop → Battery → Unrestricted
- Check if app is in "Sleeping apps" or "Deep sleeping apps" list (remove if present)
- Ensure app is pinned in Recents

**MQTT Connection Failures**:
- Test from device: `ping mqtt.home`
- Verify DNS resolution (`.home` domain)
- Check MQTT credentials in `gradle.properties`
- Test MQTT from command line: `mosquitto_sub -h mqtt.home -u chillloop_mobile -P <password> -t 'test'`

**No Audio Metrics Publishing**:
- Check service notification is visible in status bar
- Review app logs: `adb logcat | grep ChillLoop`
- Verify RECORD_AUDIO permission granted
- Test microphone in another app (Camera, Voice Recorder)

**"Silent" Status Only (No dB Readings)**:
- Speak loudly (>60dB SPL typical conversation)
- Silence threshold is -40.0 dBFS (very low ambient noise)
- Check calibration offset: 94.0dB (standard for phone mics)

### Files in Android Audio Node

**Location**: `clients/android-audio/` (if project includes Android source)

- **build.gradle.kts**: Dependencies & BuildConfig
- **app/node/NodeConfig.kt**: Configuration data class
- **app/node/AndroidAudioNodeService.kt**: Foreground service
- **app/audio/AudioRmsAnalyzer.kt**: dB computation (16-bit PCM → dBFS → dB SPL)
- **app/mqtt/MqttClientWrapper.kt**: MQTT client with coroutines
- **config/android_audio_nodes.yaml**: Device definitions
- **config/schema/audio-metrics.schema.json**: Metrics payload validation
- **config/schema/audio-event.schema.json**: Event payload validation

### Production TODOs (P2 - Post-Christmas)

- [ ] Move credentials to Android Keystore
- [ ] Implement uns.json service discovery bootstrap
- [ ] Add MQTT reconnection logic with exponential backoff
- [ ] Implement wake-word detection (Porcupine SDK)
- [ ] Add UI panel for room state display

### Version Compatibility

| Component | Version | CL-CORE Target | Status |
|-----------|---------|----------------|--------|
| Android Audio Node | 0.2.0 | 1.0.0 | Production-Ready |
| uns.json | 1.0.1 | 1.0.0 | Stable |
| MQTT Broker | Any | - | Compatible |

---

**END OF CLAUDE.MD**
